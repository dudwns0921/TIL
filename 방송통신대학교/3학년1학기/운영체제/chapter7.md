# 운영체제

## 교착상태 2

### 교착상태 회피

- 프로세스의 자원 사용에 대한 사전 정보를 활용하여 교착상태가 발생하지 않는 상태에 머물도록 하는 방법
- 사전 정보
  - 현재 할당된 자원
  - 가용상태의 자원
  - 프로세스들의 최대 요구량

### 안전상태와 안전순서열

- 안전상태
  - 교착상태를 회피하면서 각 프로세스에 그들의 최대 요구량까지 빠짐없이 자원을 할당할 수 있는 상태
  - 안전순서열이 존재하는 경우
    - 교착상태를 회피하면서 프로세스들의 최대 요구량까지 자원을 할당하며 순서대로 프로세스들을 종료할 수 있는 순서
- 불안전상태
  - 안전순서열이 존재하지 않는 경우
  - 교착상태는 불안전상태일 때만 일어날 수 있음
  - 안전상태만 유지할 수 있다면, 절대로 교착상태가 발생하지 않음

### 안전순서열

- 순서 있는 프로세스의 집합
- 각 프로세스에 대해 프로세스가 추가로 요구할 수 있는 자원의 양이 현재 가용상태의 자원으로 충당되거나 혹은 여기에 다른 프로세스에 할당된 자원까지 포함하여 충당 가능한 경우
- 가용상태의 자원으로 최대요구량을 채울 수 있는 프로세스를 안전순서열의 첫 번째 순서로 둔다.
- 해당 프로세스가 종료되고 프로세스에 할당된 자원을 가용상태의 자원으로 가져온다.
- 동일한 방법으로 다음으로 실행할 프로세스의 순서를 정한다.
- 만약 가용상태의 자원으로 최대요구량을 채울 수 있는 프로세스가 없다면 안전 순서열을 만들 수 없다. 이를 불안전상태라고 한다.
- 이런 상황이 만들어질 수 있는 가능성을 배제하기 위해 특정 프로세스가 자원을 요구할 때 자원을 할당하지 않을 수 있다. 안전상태를 유지하기 위해

### 교착상태 회피

- 교착상태는 불안전상태에서만 발생 가능
- 가능성이 있다는 건 생기지 않을 수도 있음
- 항상 안전상태를 유지해야 함
- 프로세스가 가용상태의 자원을 요구하더라도 프로세스는 대기상태가 될 수 있음
  - 자원이용률이 다소 낮아질 수 있음

### 교착상태 회피 알고리즘

- 각 자원의 단위자원이 하나밖에 없는 경우
  - 변형된 자원할당 그래프 이용
- 각 자원의 단위자원이 여러 개일 수 있는 경우
  - 은행원 알고리즘 이용

### 각 자원의 단위자원이 하나밖에 없는 경우

- 변형된 자원할당 그래프
  - 자원 정점에 표시하던 단위자원의 개수 제거
  - 선언간선 추가
    - 앞으로 프로세스 p가 r을 요구하게 될 것임
    - 요구간선과 구분을 위해 점선으로 표시
  - 자원을 요구받으면 해당 선언간선을 요구 간선으로 변경
  - 그 요구간선을 할당간선으로 변환해도 사이클이 생기지 않는 경우에만 자원을 할당하고 할당간선으로 변환, 선언간선까지 포함

### 각 자원의 단위자원이 여러 개일 수 있는 경우

- 은행원 알고리즘
  - 자원을 요구받으면 그 자원을 할당해 주고 난 후의 상태를 계산해서 그것이 안전상태인지 확인
  - 안전상태가 보장되는 경우에만 자원을 할당
  - MAX : 최대요구
  - ALLOC : 할당자원
  - NEED : 추가요구
  - AVAIL : 가용자원
  - 자원이 많아지면, 추가 자원에 대한 표기를 각 항목의 () 안에 콤마로 연결해서 표현
  - 현재 가용한 자원을 WORK 라는 변수에 다시 할당
  - 모든 프로세스의 FINISH 라는 변수를 false로 할당
  - WORK 의 값이 NEED 의 값을 만족할 수 있는지 확인
  - 프로세스가 종료되면 WORK + ALLOC
  - FINISH의 값을 false에서 true로 변경

### 교착상태 탐지 및 복구

- 사후에 처리하는 방법
- 교착상태 탐지
  - 시스템의 교착상태 여부를 조사하기 위해 주기적으로 상태 조사 알고리즘 수행
  - Shoshani와 Coffman 알고리즘
  - 위 두 알고리즘은 현재 상황이 교착인지 아닌지 체크
  - 자원이 할당되지 않으면 굳이 FINISH 변수의 값을 할당할 필요는 없음
  - 이중 반복문, 자원의 개수만큼 수행
  - O(mn2)
  - 매번 수행하기 힘든 알고리즘
  - 알고리즘 수행 시점
    - 즉시 받아들일 수 없는 자원 요구가 있을 때
    - 정해진 시간 간격
    - CPU 효율이 일정 수준 이하로 떨어질 때
- 교착상태 복구
  - 교착상태가 탐지된 경우 적절한 조치를 취해 정상상태로 복구
  - 복구의 주체
    - 오퍼레이터
      - 수작업으로 복구
    - 운영체제
      - 자동으로 복구
  - 복구방법
    - 교착상태 프로세스를 종료
    - 교착상태 프로세스가 할당받은 자원을 해제
      - 사이클이 제거될 떄까지 할당된 자원을 단계적으로 선점하여 다른 프로세스들에 할당
      - 프로세스와 자원 선택 기준
        - 프로세스 진척도, 사용 중인 자원의 수 등
      - 프로세스의 복귀 시점도 제반 요소를 고려하여 결정
      - 기아상태에 빠지지 않도록 프로세스 선택 시 복구 횟수 고려
