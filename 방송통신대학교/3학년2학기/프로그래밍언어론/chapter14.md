# 프로그래밍 언어론

## 14강. 서브프로그램 구현

### 1) 서브프로그램 구현 개요

#### 서브프로그램 연결

- 서브프로그램을 호출하는 작업
  - 호출자의 상태 저장
  - 인수전달
  - 복귀 주소 저장
  - 피호출자로 분기
- 서브프로그램으로부터 복귀하는 작업
  - 형식인수 값 복사
  - 반환값 전달
  - 상태 복귀
  - 호출자로 복귀
- 위 두 작업을 연결

#### 활성 레코드

- 수행 중인 서브프로그램에서 데이터 부분이 저장되는 형태
- 활성 레코드
  - 저장해야 할 정보의 틀
  - 틀 자체는 정적으로 결정
- 활성 레코드 인스턴스
  - 활성 레코드에 구체적인 값이 들어가 있는 형태
  - 저장되는 내용은 동적으로 결정

#### Algol의 활성 레코드 구현

- 활성 레코드를 동적 할당
  - 스택에 할당
- 프레임 포인터
  - 활성 레코드의 기준 지점
- 변위
  - 프레임 포인터로부터 떨어진 정도
- 프레임 포인터와 변위 두 값을 세트로 해서 활성 레코드에서 필요한 값을 찾음
- 정적 링크
  - 정적 부모의 프레임 포인터
- 동적 링크
  - 호출자의 프레임 포인터

#### C의 활성 레코드 구현

- 서브프로그램 중첩 불가
  - 정적 링크 없음
  - 자신을 내포하고 있는 정적 부모의 링크
  - 서브 프로그램의 중첩이 불가하므로 정적 링크가 필요하지 않음

#### 서브프로그램 관련 용어

- 동적 체인
  - 활성 레코드 스택 상에서 인접한 동적 링크들을 차례로 연결한 것
  - 하나의 리스트 형태
- 정적 체인
  - 활성 레코드 스택 중에서 정적 링크들을 연결한 것
  - 개별적인 서브프로그램의 관점에서는 리스트 형태
  - 하지만 전체적인 관점에서는 트리 형태를 가짐
- 지역 변위
  - 프레임 포인터에서 스택 동적 변수 위치까지의 변위

### 2) 정적 체인과 동적 체인

#### 비지역변수 참조

- 참조되는 비지역변수는 활성 레코드 스택 상에서 존재
- 올바른 활성 레코드만 찾으면 지역 변위로 변수 위치 찾음
- 정적 체인 활용
- 동적 체인 활용
  - 참조할 비지역변수를 컴파일 시간에 결정할 수 없음

#### 정적 체인

- 변수 참조
  - 체인 변위
  - 지역 변위

- 용어
  - 정적 깊이
    - 정적 영역의 중첩 깊이
    - 자신을 감싸고 있는 정적 영역의 개수
  - 체인 변위
    - 비지역변수를 참조하는 정적 영역과 비지역변위가 선언된 정적 영역의 정적 깊이 차이

#### 정적 체인 구성

- 서브프로그램 호출 시 정적 링크는 정적 부모의 최근 활성 레코드를 가리키도록 설정
- 방법 1
  - 동적 링크를 계속 거슬러 올라가며 정적 부모 탐색
    - 활성 레코드 스택에 서브프로그램 이름 저장해야하므로 비효율적
- 방법2
  - 호출자와 피호출자의 정적 깊이 차이 이용

#### 정적 체인 평가

- 장점
  - 구현이 쉬움
  - 공간 낭비 적음
- 단점
  - 체인 변위가 큰 경우 비지역변수 참조시간 부담
  - 비지역변수 참조 시간이 변수에 따라 다름

#### 동적 체인

- 변수 참조
  - 비지역변수를 찾을 때까지 동적 링크를 거슬러 올라감
- 호출 순서에 따라 참조하는 비지역변수가 달라질 수 있음
- 활성 레코드에 변수 이름을 저장해야 함
  - 비효율적
  - 정적 체인은 지역 변위를 통해 변수를 찾아가면 되고, 그 이름을 알 필요가 없음

### 3) 기타 서브프로그램 구현 방법

#### 디스플레이

- 정적 체인 방법을 대체할 수 있는 방법
- 수행 중 참조할 수 있는 모든 정적 링크를 별도의 스택에 관리
- 디스플레이
  - 현재 수행 중인 블록과 이 블록의 모든 정적 조상에 대한 활성 레코드를 가리키는 포인터로 이루어진 스택
- 변수 참조
  - 디스플레이 변위와 지역 변위를 통해 변수 참조
- 디스플레이 변위
  - 원하는 활성 레코드에 대한 포인터가 디스플레이 스택에서 몇 번째에 저장되어 있는지 나타내는 색인 값
  - 찾을 변수가 선언된 서브프로그램의 정적 깊이와 동일

#### 정적 체인과 디스플레이 비교

비지역변수가 멀리 떨어져있는 경우에는 디스플레이가 효율적

#### 변수 스택과 중앙 테이블

- 동적 체인 방법의 비효율성 개선

- 변수 스택
  - 변수 이름마다 별도의 스택을 두는 방법
  - 스택에는 서브프로그램의 활성 레코드에 대한 포인터가 저장됨

- 중앙 테이블
  - 각 변수에 대해 실제 사용할 수 있는지 여부와 실제 값을 하나의 표에 저장해 두는 방법
  - 변수의 활성 플래그가 이미 활성화되어 있으면 은닉 스택에 백업

#### 과거 민감 서브프로그램

- 이전 호출 내용을 기억하는 서브프로그램
  - 서브프로그램이 종료되어도 상태 정보 일부가 기억됨
- 구현
  - 전역변수 이용 : 정보 은닉이 보장되지 않음
  - 정적 지역변수 이용 : 정보 은닉 보장

- 코루틴
  - 여러 개의 진입 지점을 스스로 관리하는 서브프로그램을 뜻함
  - 코루틴은 ‘호출된다’고 하지 않고 ‘재개된다’고 한다.
